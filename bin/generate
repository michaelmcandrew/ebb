#!/usr/bin/env php
<?php
require_once 'vendor/autoload.php';
use Illuminate\Support\Str;
use Symfony\Component\Cache\Simple\FilesystemCache;

$dotenv = new Dotenv\Dotenv(__DIR__ .'/..');
$dotenv->load();
$dotenv->required([
  'CIVI_REST_API_BASE_URL',
  'INTERFACE_DIR'
]);

$cache = new FilesystemCache('', 0, __DIR__ .'/../cache/api');
$api = new Cig\RestApi(
  getenv('CIVI_REST_API_BASE_URL'),
  $cache
);

$loader = new Twig_Loader_Filesystem('templates');
$twig = new Twig_Environment($loader);

$ngDir = getenv('INTERFACE_DIR');
$modelTemplate = $twig->load('entity.model.ts.twig');
$componentTemplate = $twig->load('entity/entity.component.ts.twig');
$componentHTMLTemplate = $twig->load('entity/entity.component.html.twig');
$componentTestTemplate = $twig->load('entity/entity.component.spec.ts.twig');
$componentCSSTemplate = $twig->load('entity/entity.component.css.twig');

// From CRM_Utils_Type::typeToString()
$types = [
  1 => 'number',
  2 => 'string',
  4 => 'Date',
  12 => 'Date',
  16 => 'boolean',
  32 => 'string',
  64 => 'string', // Not sure about this one. Used once in CaseType
  256 => 'Date',
  512 => 'number',
  1024 => 'number', // Might be worth switching to a Money type at some point
  4096 => 'string', // Might be worth switching to an Email type at some point (or should that be done at the component level?)
  16384 => 'string', // Not sure about this one. Used once in File
  // 8 => 'Time', // not used
  // 2048 => 'Date', // not used
  '' => 'string',
  'Array' => 'string', // Not sure about this one. Used once in Setting
  'Boolean' => 'boolean',
  'Date' => 'Date',
  'Int' => 'number',
  'Integer' => 'number',
  'String' => 'string',
  'Text' => 'string',
];

$entities = $api->query('Entity', 'get');
foreach($entities['values'] as $entity){

  $name['UpperCamel'] = ucfirst(Str::camel($entity));
  $name['lowerCamel'] = lcfirst(Str::camel($entity));
  $name['kebab'] = Str::kebab($entity);

  $fields = $api->query($entity, 'getfields')['values'];
  foreach($fields as &$field) {

    // Clean types
    if(!isset($field['type'])){
      $field['type'] = 2;
    }
    if(isset($types[$field['type']])){
      $field['ts_type'] = $types[$field['type']];
    }else{
      echo "Could not find type for {$entity}.{$field['name']}\n";
      var_dump($field);
    }

  }

  // Generate model
  file_put_contents("{$ngDir}/app/{$name['kebab']}.model.ts", $modelTemplate->render([
    'name' => $name,
    'fields' => $fields,
  ]));

  // Generate component directory
  $componentDir = "{$ngDir}/app/{$name['kebab']}";
  if(!is_dir($componentDir)) {
    mkdir($componentDir);
  }

  // Generate component file
  file_put_contents("{$ngDir}/app/{$name['kebab']}/{$name['kebab']}.component.ts", $componentTemplate->render([
    'name' => $name,
    'fields' => $fields,
  ]));

  // Generate component html
  file_put_contents("{$ngDir}/app/{$name['kebab']}/{$name['kebab']}.component.html", $componentHTMLTemplate->render([
    'name' => $name,
    'fields' => $fields,
  ]));

  // Generate component test
  file_put_contents("{$ngDir}/app/{$name['kebab']}/{$name['kebab']}.component.spec.ts", $componentTestTemplate->render([
    'name' => $name,
    'fields' => $fields,
  ]));

  // Generate component css
  file_put_contents("{$ngDir}/app/{$name['kebab']}/{$name['kebab']}.component.css", $componentCSSTemplate->render([
    'name' => $name,
    'fields' => $fields,
  ]));

}
